<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Único de Certificación</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF CDN para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos personalizados para la tipografía y el fondo */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Fondo suave */
        }
        .container-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <!-- Overlay de Carga Inicial -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p class="ml-4 text-indigo-600 font-semibold">Cargando datos...</p>
    </div>

    <!-- Contenedor Principal -->
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div id="mainContainer" class="w-full max-w-xl bg-white p-6 md:p-10 rounded-xl container-shadow transition-all duration-300">

            <!-- Título y Mensaje de Error/Información -->
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Examen de Certificación Único</h1>
            <p class="text-center text-gray-500 mb-8">Para empezar, introduce tu nombre y correo. El examen solo se puede completar una vez por cuenta.</p>

            <!-- Contenedor de Alerta/Mensaje -->
            <div id="messageBox" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

            <!-- 1. Pantalla de Inicio (Name & Email Input) -->
            <div id="startScreen">
                <div class="mb-4">
                    <label for="nameInput" class="block mb-2 text-sm font-medium text-gray-900">Nombre Completo</label>
                    <input type="text" id="nameInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="Tu Nombre" required>
                </div>
                <div class="mb-6">
                    <label for="emailInput" class="block mb-2 text-sm font-medium text-gray-900">Correo Electrónico</label>
                    <input type="email" id="emailInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="tu.correo@ejemplo.com" required>
                </div>
                <button onclick="startExam()" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-lg px-5 py-3 text-center transition-colors duration-200 shadow-md hover:shadow-lg">
                    Iniciar Examen
                </button>
            </div>

            <!-- 2. Pantalla del Examen -->
            <div id="quizScreen" class="hidden">
                <div id="questionContainer">
                    <!-- Las preguntas se inyectarán aquí -->
                </div>
                <div class="mt-8 flex justify-between items-center">
                    <button id="prevBtn" onclick="prevQuestion()" class="text-indigo-600 border border-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg transition duration-150 font-medium disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                    <div id="progressText" class="text-sm text-gray-600"></div>
                    <button id="nextBtn" onclick="nextQuestion()" class="text-white bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition duration-150 font-medium">Siguiente</button>
                    <button id="submitBtn" onclick="submitExam()" class="hidden text-white bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition duration-150 font-medium">Finalizar</button>
                </div>
            </div>

            <!-- 3. Pantalla de Resultados -->
            <div id="resultScreen" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">¡Examen Finalizado!</h2>
                <div class="text-5xl font-extrabold text-indigo-600 mb-4" id="scoreDisplay"></div>
                <p class="text-lg text-gray-600 mb-6" id="messageStatus"></p>

                <button onclick="generatePDF()" class="inline-flex items-center text-white bg-pink-600 hover:bg-pink-700 focus:ring-4 focus:outline-none focus:ring-pink-300 font-medium rounded-lg text-md px-6 py-3 text-center transition-colors duration-200 shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Descargar Certificado PDF
                </button>
                <p class="text-xs text-gray-400 mt-4">Tu resultado ha sido registrado y no podrás repetir el examen con este correo.</p>
            </div>

        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, query, where, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de log para depuración de Firestore
        setLogLevel('Debug');

        // Variables globales (proporcionadas por el entorno Canvas/GitHub)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-exam-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = 'anonymous';

        // Constantes del DOM
        const startScreen = document.getElementById('startScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultScreen = document.getElementById('resultScreen');
        const questionContainer = document.getElementById('questionContainer');
        const nameInput = document.getElementById('nameInput'); // Nuevo Input de Nombre
        const emailInput = document.getElementById('emailInput');
        const messageBox = document.getElementById('messageBox');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Estado del examen
        let currentQuestionIndex = 0;
        let userAnswers = {}; // { 0: 'A', 1: 'C', ... }
        let userName = ''; // Nuevo estado para el Nombre
        let userEmail = '';
        let examAttemptDocId = null;
        
        // ** CAMBIO CLAVE: Lógica para seleccionar 10 preguntas aleatorias de 50 **
        const FULL_QUESTION_BANK = [
            { question: "¿Qué es una constante en una fórmula de Excel?", options: {A: "Un valor que cambia según la celda", B: "Un valor fijo que no depende de otras celdas", C: "Un operador lógico", D: "Una función automática"}, correctAnswer: "B" },
            { question: "¿Cuál de los siguientes es un operador aritmético en Excel?", options: {A: "&", B: "=", C: "+", D: "%"}, correctAnswer: "C" },
            { question: "¿Qué operador se usa para concatenar texto en Excel?", options: {A: "+", B: "*", C: "&", D: "="}, correctAnswer: "C" },
            { question: "¿Qué representa la fórmula =A1+B1 en Excel?", options: {A: "Una constante", B: "Una suma entre dos referencias", C: "Una función lógica", D: "Un vínculo externo"}, correctAnswer: "B" },
            { question: "¿Qué tipo de referencia cambia al copiar la fórmula a otra celda?", options: {A: "Absoluta", B: "Relativa", C: "Parcial", D: "Fija"}, correctAnswer: "B" },
            { question: "¿Cómo se representa una referencia absoluta en Excel?", options: {A: "A1", B: "$A$1", C: "A$1", D: "$A1"}, correctAnswer: "B" },
            { question: "¿Qué tipo de referencia es A$1?", options: {A: "Absoluta", B: "Relativa", C: "Parcialmente absoluta", D: "Constante"}, correctAnswer: "C" },
            { question: "¿Qué ventaja tiene usar referencias absolutas en fórmulas de costos industriales?", options: {A: "Permiten copiar fórmulas sin errores", B: "Cambian automáticamente", C: "Se actualizan con filtros", D: "Se usan solo en macros"}, correctAnswer: "A" },
            { question: "¿Qué ocurre si se usa una referencia relativa en una fórmula de producción?", options: {A: "El valor se mantiene fijo", B: "La fórmula se adapta al copiarla", C: "Se bloquea la celda", D: "Se borra el contenido"}, correctAnswer: "B" },
            { question: "¿Qué representa la fórmula =$B$2*A3 en un análisis de costos unitarios?", options: {A: "Multiplicación entre dos valores fijos", B: "Multiplicación entre un valor fijo y uno variable", C: "Suma de dos constantes", D: "División entre dos celdas"}, correctAnswer: "B" },
            { question: "¿Qué es el asistente de funciones en Excel?", options: {A: "Un menú para insertar gráficos", B: "Una herramienta para crear macros", C: "Una guía para construir fórmulas", D: "Un filtro de datos"}, correctAnswer: "C" },
            { question: "¿Cuál es la función que permite contar celdas con valores numéricos?", options: {A: "SUMA", B: "CONTAR", C: "PROMEDIO", D: "SI"}, correctAnswer: "B" },
            { question: "¿Qué función se usa para calcular el promedio de producción mensual?", options: {A: "SUMA", B: "CONTAR", C: "PROMEDIO", D: "MAX"}, correctAnswer: "C" },
            { question: "¿Qué función devuelve el valor más alto en una serie de datos?", options: {A: "MIN", B: "MAX", C: "PROMEDIO", D: "CONTAR"}, correctAnswer: "B" },
            { question: "¿Qué función se usa para sumar los valores de una columna?", options: {A: "SUMA", B: "CONTAR", C: "SI", D: "BUSCAR"}, correctAnswer: "A" },
            { question: "¿Qué función permite tomar decisiones en base a una condición?", options: {A: "SI", B: "SUMA", C: "BUSCAR", D: "CONTAR"}, correctAnswer: "A" },
            { question: "¿Cuál es el resultado de =SI(A1>100,\"Exceso\",\"Normal\") si A1=120?", options: {A: "Exceso", B: "Normal", C: "120", D: "Error"}, correctAnswer: "A" },
            { question: "¿Qué función se usa para buscar un valor en una tabla vertical?", options: {A: "BUSCARV", B: "BUSCARH", C: "SI", D: "CONTAR"}, correctAnswer: "A" },
            { question: "¿Qué función se usa para buscar un valor en una tabla horizontal?", options: {A: "BUSCARV", B: "BUSCARH", C: "SI", D: "SUMA"}, correctAnswer: "B" },
            { question: "¿Qué función lógica se puede combinar con BUSCARV para validar resultados?", options: {A: "SI", B: "CONTAR", C: "PROMEDIO", D: "MAX"}, correctAnswer: "A" },
            { question: "¿Qué representa un vínculo entre hojas en Excel?", options: {A: "Una fórmula que conecta celdas de distintas hojas", B: "Un gráfico dinámico", C: "Una macro", D: "Un filtro avanzado"}, correctAnswer: "A" },
            { question: "¿Cómo se vincula una celda de otra hoja en Excel?", options: {A: "=Hoja2!A1", B: "=A1", C: "=SUMA(A1:A10)", D: "=BUSCARV(A1)"}, correctAnswer: "A" },
            { question: "¿Qué ventaja tiene vincular hojas en un análisis de inventario?", options: {A: "Permite consolidar datos automáticamente", B: "Evita el uso de fórmulas", C: "Protege la hoja", D: "Elimina duplicados"}, correctAnswer: "A" },
            { question: "¿Qué ocurre si se elimina una hoja vinculada?", options: {A: "Se actualiza el vínculo", B: "Se borra el libro", C: "Aparece un error en la fórmula", D: "Se protege la celda"}, correctAnswer: "C" },
            { question: "¿Qué representa la fórmula =Hoja1!B2+Hoja3!C4 en un análisis de producción?", options: {A: "Suma de dos valores en la misma hoja", B: "Suma de valores en hojas distintas", C: "Promedio de dos celdas", D: "Vínculo externo"}, correctAnswer: "B" },
            { question: "¿Qué permite hacer el filtro avanzado en Excel?", options: {A: "Ordenar alfabéticamente", B: "Buscar errores", C: "Extraer datos que cumplen criterios específicos", D: "Crear gráficos"}, correctAnswer: "C" },
            { question: "¿Qué se necesita para aplicar un filtro avanzado?", options: {A: "Una tabla dinámica", B: "Un rango de criterios", C: "Una macro", D: "Un vínculo externo"}, correctAnswer: "B" },
            { question: "¿Qué ventaja tiene el filtro avanzado en análisis de calidad industrial?", options: {A: "Permite ocultar columnas", B: "Permite extraer registros que cumplen condiciones específicas", C: "Permite proteger la hoja", D: "Permite sumar automáticamente"}, correctAnswer: "B" },
            { question: "¿Qué representa el rango de criterios en un filtro avanzado?", options: {A: "El área donde se colocan los encabezados y condiciones", B: "El área donde se colocan los gráficos", C: "El área donde se colocan las fórmulas", D: "El área donde se colocan los vínculos"}, correctAnswer: "A" },
            { question: "¿Qué ocurre si el rango de criterios no coincide con los encabezados?", options: {A: "Se ejecuta el filtro", B: "Se genera un error", C: "Se ocultan los datos", D: "Se actualiza automáticamente"}, correctAnswer: "B" },
            { question: "¿Qué función permite evitar que se modifiquen celdas en una hoja de Excel?", options: {A: "Filtro", B: "Protección de hoja", C: "Validación de datos", D: "Formato condicional"}, correctAnswer: "B" },
            { question: "¿Qué se puede hacer al proteger un libro de Excel?", options: {A: "Evitar que se eliminen hojas", B: "Ocultar fórmulas", C: "Crear vínculos", D: "Aplicar filtros"}, correctAnswer: "A" },
            { question: "¿Qué opción permite proteger solo ciertas celdas en una hoja?", options: {A: "Ocultar columnas", B: "Bloquear celdas específicas", C: "Aplicar formato", D: "Usar macros"}, correctAnswer: "B" },
            { question: "¿Qué ventaja tiene proteger hojas en análisis de producción?", options: {A: "Evita errores al modificar fórmulas clave", B: "Permite sumar automáticamente", C: "Permite copiar datos", D: "Permite crear gráficos"}, correctAnswer: "A" },
            { question: "¿Qué ocurre si se protege una hoja sin desbloquear celdas clave?", options: {A: "Se pueden editar todas las celdas", B: "No se puede modificar ninguna celda", C: "Se eliminan los datos", D: "Se actualizan los vínculos"}, correctAnswer: "B" },
            { question: "¿Qué significa “anidar funciones” en Excel?", options: {A: "Usar funciones en hojas distintas", B: "Combinar varias funciones dentro de una fórmula", C: "Proteger una celda", D: "Crear vínculos"}, correctAnswer: "B" },
            { question: "¿Cuál es un ejemplo de función anidada?", options: {A: "=SI(A1>100,\"Alto\",\"Bajo\")", B: "=SI(A1>100,SUMA(B1:B5),PROMEDIO(B1:B5))", C: "=SUMA(A1:A10)", D: "=BUSCARV(A1,B1:C10,2,FALSO)"}, correctAnswer: "B" },
            { question: "¿Qué ventaja tiene anidar funciones en análisis de eficiencia?", options: {A: "Permite realizar cálculos complejos en una sola fórmula", B: "Permite ocultar datos", C: "Permite proteger la hoja", D: "Permite copiar celdas"}, correctAnswer: "A" },
            { question: "¿Qué función se puede anidar dentro de SI para validar rangos?", options: {A: "CONTAR", B: "Y", C: "MAX", D: "BUSCARH"}, correctAnswer: "B" },
            { question: "¿Qué representa la fórmula =SI(Y(A1>50,B1<100),\"Aceptable\",\"Revisar\")?", options: {A: "Una función lógica simple", B: "Una función anidada con condición doble", C: "Una fórmula de búsqueda", D: "Una fórmula de suma"}, correctAnswer: "B" },
            { question: "¿Qué fórmula usarías para calcular el costo total si el precio está en B2 y la cantidad en C2?", options: {A: "=B2+C2", B: "=B2*C2", C: "=SUMA(B2:C2)", D: "=SI(B2>C2,\"Mayor\",\"Menor\")"}, correctAnswer: "B" },
            { question: "¿Qué función usarías para identificar si un lote cumple con el estándar mínimo de calidad?", options: {A: "SUMA", B: "SI", C: "BUSCARV", D: "CONTAR"}, correctAnswer: "B" },
            { question: "¿Qué fórmula permite calcular el promedio de producción semanal?", options: {A: "=SUMA(A1:A7)", B: "=PROMEDIO(A1:A7)", C: "=MAX(A1:A7)", D: "=SI(A1>100,\"Alto\",\"Bajo\")"}, correctAnswer: "B" },
            { question: "¿Qué función usarías para buscar el nombre de un proveedor según su código?", options: {A: "BUSCARV", B: "SI", C: "CONTAR", D: "PROMEDIO"}, correctAnswer: "A" },
            { question: "¿Qué fórmula permite validar si el inventario está por debajo del mínimo requerido?", options: {A: "=SI(A1<50,\"Reponer\",\"Suficiente\")", B: "=SUMA(A1:A10)", C: "=BUSCARV(A1,B1:C10,2,FALSO)", D: "=MAX(A1:A10)"}, correctAnswer: "A" },
            { question: "¿Qué representa la fórmula =SI(O(A1=\"Sí\",B1=\"Sí\"),\"Aprobado\",\"Pendiente\")?", options: {A: "Función de suma", B: "Función lógica con condición múltiple", C: "Función de búsqueda", D: "Función de promedio"}, correctAnswer: "B" },
            { question: "¿Qué fórmula usarías para calcular el porcentaje de cumplimiento si producción real está en B2 y meta en C2?", options: {A: "=B2+C2", B: "=B2/C2", C: "=SI(B2>C2,\"Cumplido\",\"Falta\")", D: "=SUMA(B2:C2)"}, correctAnswer: "B" },
            { question: "¿Qué función permite contar cuántos productos cumplen con una condición específica?", options: {A: "CONTAR.SI", B: "SUMA", C: "PROMEDIO", D: "BUSCARV"}, correctAnswer: "A" },
            { question: "¿Qué fórmula usarías para mostrar “Revisión” si el valor está fuera del rango 50–100?", options: {A: "=SI(Y(A1>=50,A1<=100),\"OK\",\"Revisión\")", B: "=SI(A1>100,\"Revisión\",\"OK\")", C: "=SUMA(A1:A10)", D: "=BUSCARV(A1,B1:C10,2,FALSO)"}, correctAnswer: "A" },
            { question: "¿Qué representa la fórmula =SI(B2=\"Activo\",SI(C2>100,\"Alta producción\",\"Media producción\"),\"Inactivo\")?", options: {A: "Función de búsqueda", B: "Función anidada con doble condición", C: "Función de suma", D: "Función de filtro"}, correctAnswer: "B" }
        ];
        
        const QUESTIONS_TO_SHOW = 10; // Mostrar 10 preguntas aleatorias
        let selectedQuestions = []; // Array para las 10 preguntas seleccionadas

        /**
         * Selecciona un número fijo de preguntas aleatorias del banco.
         */
        function selectRandomQuestions(bank, count) {
            if (bank.length <= count) {
                return [...bank]; 
            }
            
            // Algoritmo de muestreo aleatorio
            const shuffled = [...bank]
                .map(value => ({ value, sort: Math.random() })) // Asignar un valor aleatorio
                .sort((a, b) => a.sort - b.sort) // Ordenar
                .map(({ value }) => value); // Obtener solo los objetos

            return shuffled.slice(0, count); // Tomar las primeras 'count' preguntas
        }
        // Fin de la lógica de selección aleatoria
        


        // --- Funciones de Utilidad y UI ---

        function showMessage(type, message) {
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
            
            let classes = '';
            if (type === 'error') {
                classes = 'bg-red-100 border-red-400 text-red-700 border-l-4';
            } else if (type === 'success') {
                classes = 'bg-green-100 border-green-400 text-green-700 border-l-4';
            } else { // info
                classes = 'bg-blue-100 border-blue-400 text-blue-700 border-l-4';
            }
            messageBox.className = `p-4 mb-4 text-sm rounded-lg ${classes}`;
            messageBox.innerHTML = message;
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function toggleLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function renderQuestion() {
            hideMessage();
            if (currentQuestionIndex >= selectedQuestions.length) {
                return;
            }

            const q = selectedQuestions[currentQuestionIndex];
            
            // Renderizar la pregunta
            questionContainer.innerHTML = `
                <div class="p-6 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                    <p class="text-lg font-semibold text-gray-800 mb-4">
                        <span class="text-indigo-600 mr-2">Pregunta ${currentQuestionIndex + 1} de ${selectedQuestions.length}.</span> ${q.question}
                    </p>
                    <div id="optionsGroup" class="space-y-4">
                        ${Object.entries(q.options).map(([key, value]) => `
                            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition duration-150 hover:bg-indigo-50 has-checked:bg-indigo-100 has-checked:border-indigo-500">
                                <input 
                                    type="radio" 
                                    name="question_${currentQuestionIndex}" 
                                    value="${key}" 
                                    class="w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 focus:ring-indigo-500" 
                                    onchange="handleAnswerChange(${currentQuestionIndex}, '${key}')"
                                    ${userAnswers[currentQuestionIndex] === key ? 'checked' : ''}
                                >
                                <span class="ml-3 text-base font-medium text-gray-700">${key}: ${value}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            // Actualizar botones de navegación
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').classList.toggle('hidden', currentQuestionIndex === selectedQuestions.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', currentQuestionIndex < selectedQuestions.length - 1);
            
            // Actualizar texto de progreso
            document.getElementById('progressText').textContent = `Pregunta ${currentQuestionIndex + 1} de ${selectedQuestions.length}`;
        }

        window.handleAnswerChange = (index, answer) => {
            userAnswers[index] = answer;
        };

        window.prevQuestion = () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        };

        window.nextQuestion = () => {
            if (!userAnswers[currentQuestionIndex]) {
                showMessage('error', 'Por favor, selecciona una opción antes de continuar.');
                return;
            }

            if (currentQuestionIndex < selectedQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        };


        // --- Funciones de Firestore ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config no está disponible.");
                showMessage('error', 'Error: La configuración de Firebase no está disponible.');
                return false;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            resolve();
                        } else {
                            console.error("No se pudo obtener un usuario autenticado.");
                            showMessage('error', 'Error de autenticación. Intenta refrescar la página.');
                        }
                        unsubscribe();
                    });
                });
                return true;

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                showMessage('error', `Error de inicio de sesión: ${error.message}.`);
                return false;
            }
        }

        function getExamAttemptsCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/exam_attempts`);
        }

        async function checkExamAttempt(email) {
            const q = query(getExamAttemptsCollectionRef(), where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                return { exists: false, finished: false };
            }

            const docData = querySnapshot.docs[0].data();
            examAttemptDocId = querySnapshot.docs[0].id;
            return { exists: true, finished: docData.status === 'completed' };
        }

        async function recordExamAttempt(email, name, status) {
            const { score, total, percentage } = calculateScore();

            const attemptData = {
                name: name, // Guardar el nombre
                email: email,
                userId: currentUserId,
                status: status, // 'started' o 'completed'
                timestamp: new Date().toISOString(),
                score: status === 'completed' ? score : 0,
                totalQuestions: selectedQuestions.length,
                percentage: status === 'completed' ? percentage.toFixed(0) : 0,
            };

            try {
                if (examAttemptDocId) {
                    await setDoc(doc(db, getExamAttemptsCollectionRef().path, examAttemptDocId), attemptData, { merge: true });
                } else {
                    // Crea un nuevo documento, usando el email como ID si es la primera vez (para facilitar el query)
                    const newDocRef = doc(db, getExamAttemptsCollectionRef().path, email);
                    await setDoc(newDocRef, attemptData);
                    examAttemptDocId = email; // Usamos el email como ID del documento
                }
                console.log(`Intento registrado/actualizado: ${status}`);
            } catch (e) {
                console.error("Error al registrar el intento:", e);
                showMessage('error', 'Error al guardar el progreso del examen.');
            }
        }


        // --- Flujo Principal del Examen ---

        window.startExam = async () => {
            userName = nameInput.value.trim(); // Obtener el nombre
            userEmail = emailInput.value.trim();
            hideMessage();

            if (!userName) {
                showMessage('error', 'Por favor, introduce tu nombre completo.');
                return;
            }
            if (!userEmail || !userEmail.includes('@') || userEmail.length < 5) {
                showMessage('error', 'Por favor, introduce un correo electrónico válido.');
                return;
            }

            toggleLoading(true);

            try {
                const attempt = await checkExamAttempt(userEmail);

                if (attempt.exists && attempt.finished) {
                    showMessage('error', `Ya has completado el examen con el correo **${userEmail}**. No se permite repetirlo.`);
                    startScreen.classList.remove('hidden');
                    quizScreen.classList.add('hidden');
                    resultScreen.classList.add('hidden');
                } else {
                    // Seleccionar las preguntas aleatorias
                    selectedQuestions = selectRandomQuestions(FULL_QUESTION_BANK, QUESTIONS_TO_SHOW);
                    
                    // Registrar inicio de examen
                    await recordExamAttempt(userEmail, userName, 'started');
                    
                    startScreen.classList.add('hidden');
                    quizScreen.classList.remove('hidden');
                    resultScreen.classList.add('hidden');
                    
                    currentQuestionIndex = 0;
                    renderQuestion();
                }
            } catch (e) {
                console.error("Error en el inicio del examen:", e);
                showMessage('error', 'Ocurrió un error al verificar tu cuenta. Por favor, revisa la consola.');
            } finally {
                toggleLoading(false);
            }
        };

        function calculateScore() {
            let correctCount = 0;
            selectedQuestions.forEach((q, index) => {
                if (userAnswers[index] === q.correctAnswer) {
                    correctCount++;
                }
            });
            const scorePercentage = (correctCount / selectedQuestions.length) * 100;
            return { score: correctCount, total: selectedQuestions.length, percentage: scorePercentage };
        }

        window.submitExam = async () => {
            if (Object.keys(userAnswers).length !== selectedQuestions.length) {
                showMessage('error', 'Debes responder todas las preguntas antes de finalizar.');
                return;
            }
            
            toggleLoading(true);

            const { score, total, percentage } = calculateScore();

            // 1. Guardar el resultado en Firestore
            await recordExamAttempt(userEmail, userName, 'completed');

            // 2. Mostrar la pantalla de resultados
            document.getElementById('scoreDisplay').textContent = `${score} / ${total}`;
            document.getElementById('messageStatus').textContent = `Hola ${userName}, tu puntuación es del ${percentage.toFixed(0)}%.`;
            
            if (percentage >= 70) {
                 document.getElementById('messageStatus').textContent += ' ¡Felicidades, has aprobado!';
            } else {
                document.getElementById('messageStatus').textContent += ' Necesitas estudiar un poco más.';
            }

            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            toggleLoading(false);
        };

        // --- Función de Generación de PDF (Corregida y Mejorada con Nombre) ---

        window.generatePDF = () => {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                showMessage('error', 'Error: Librería jsPDF no cargada correctamente.');
                return;
            }

            const { score, total, percentage } = calculateScore();
            const doc = new window.jspdf.jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 30;

            // Título
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.setTextColor(26, 35, 126); 
            doc.text("Certificado de Resultados del Examen", pageWidth / 2, y, { align: 'center' });
            y += 15;
            
            // Línea separadora
            doc.setDrawColor(26, 35, 126);
            doc.line(20, y, pageWidth - 20, y);
            y += 10;

            // Información del Participante
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(14);
            doc.setTextColor(55, 65, 81); 
            
            // Nombre Completo
            doc.setFont('helvetica', 'bold');
            doc.text("Nombre Completo:", 20, y);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(userName, 70, y);
            y += 10;
            
            // Correo
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(55, 65, 81);
            doc.text("Correo Electrónico:", 20, y);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(userEmail, 70, y);
            y += 10;
            
            // Fecha
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(55, 65, 81);
            doc.text("Fecha de Finalización:", 20, y);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(new Date().toLocaleDateString('es-ES'), 70, y);
            y += 20;

            // Resultados (Resaltados)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(26, 35, 126); 
            doc.text("Puntuación Final", pageWidth / 2, y, { align: 'center' });
            y += 10;
            
            // Caja para el Porcentaje
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(235, 245, 255);
            doc.roundedRect(pageWidth / 2 - 40, y - 5, 80, 25, 5, 5, 'F');
            
            const scoreColor = percentage >= 70 ? [27, 94, 32] : [183, 28, 28]; // Verde o Rojo
            doc.setFontSize(28);
            doc.setTextColor(scoreColor[0], scoreColor[1], scoreColor[2]);
            doc.text(`${percentage.toFixed(0)}%`, pageWidth / 2, y + 10, { align: 'center' });
            y += 25;

            doc.setFontSize(14);
            doc.setTextColor(55, 65, 81);
            doc.text(`Respuestas Correctas: ${score} de ${total}`, pageWidth / 2, y, { align: 'center' });
            y += 15;
            
            // Estado de Aprobación
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            
            if (percentage >= 70) {
                doc.setTextColor(27, 94, 32); 
                doc.text("ESTADO: APROBADO", pageWidth / 2, y, { align: 'center' });
            } else {
                doc.setTextColor(183, 28, 28); 
                doc.text("ESTADO: NO APROBADO", pageWidth / 2, y, { align: 'center' });
            }
            y += 20;

            // Pie de página
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text(`ID del Intento: ${examAttemptDocId || 'N/A'}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 25, { align: 'center' });
            doc.text("Documento generado automáticamente. Validez sujeta a la verificación en la plataforma.", pageWidth / 2, doc.internal.pageSize.getHeight() - 15, { align: 'center' });

            // Nombrar el archivo con el nombre del usuario
            const filename = `Certificado_${userName.replace(/\s+/g, '_')}.pdf`;
            doc.save(filename);
        };


        // --- Inicialización al Cargar la Ventana ---

        window.onload = async () => {
            toggleLoading(true);
            const isFirebaseReady = await initializeFirebase();
            
            if (isFirebaseReady) {
                startScreen.classList.remove('hidden');
                quizScreen.classList.add('hidden');
                resultScreen.classList.add('hidden');
            }
            toggleLoading(false);
        };
    </script>

</body>
</html>
