<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen con L√≠mite de Tiempo y Acceso √önico</title>
    <!-- Incluir Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base y fuente */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .question-card {
            min-height: 400px; /* Altura m√≠nima para evitar saltos de layout */
        }
    </style>
    
    <!-- Importaci√≥n de jsPDF para generar el comprobante -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Importaciones de Firebase (como m√≥dulo) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Establecer el nivel de log para depuraci√≥n (opcional)
        setLogLevel('Debug');

        // Variables globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userData = {}; 
        let selectedQuestions = [];
        
        // Estado de la navegaci√≥n del examen y temporizador
        let currentQuestionIndex = 0;
        let timerTimeout = null;
        let countdownInterval = null;
        let userSelections = {}; // { index: selectedValue }

        // CONSTANTE DE TIEMPO: 45 segundos
        const TIME_PER_QUESTION = 45; 

        // BANCO DE PREGUNTAS (50 preguntas seg√∫n el usuario)
        const questionBank = [
            { question: "¬øQu√© representa una prueba de significaci√≥n en el an√°lisis de datos sociales?", options: ["Una forma de medir la cantidad de datos recolectados", "Una forma de organizar encuestas", "Una t√©cnica para validar si una diferencia observada es real o producto del azar", "Un m√©todo para calcular promedios"], answer: "Una t√©cnica para validar si una diferencia observada es real o producto del azar" },
            { question: "En trabajo social, ¬øcu√°l ser√≠a un ejemplo de hip√≥tesis que puede probarse con datos?", options: ["El acceso a becas mejora la permanencia escolar en zonas vulnerables", "La pobreza es un problema global", "Los j√≥venes prefieren redes sociales", "Los adultos mayores necesitan atenci√≥n m√©dica"], answer: "El acceso a becas mejora la permanencia escolar en zonas vulnerables" },
            { question: "¬øQu√© significa un valor p menor a $0.05$ en una prueba de significaci√≥n?", options: ["Que la diferencia observada es probablemente significativa", "Que se debe repetir el estudio", "Que los datos son incorrectos", "Que no hay relaci√≥n entre variables"], answer: "Que la diferencia observada es probablemente significativa" },
            { question: "¬øCu√°l es el objetivo de una prueba no param√©trica en trabajo social?", options: ["Calcular la media de ingresos", "Determinar el tama√±o de la muestra", "Medir la edad promedio de una comunidad", "Analizar datos que no siguen una distribuci√≥n normal"], answer: "Analizar datos que no siguen una distribuci√≥n normal" },
            { question: "¬øQu√© tipo de variable se analiza con pruebas de nivel nominal?", options: ["Edad", "N√∫mero de hijos", "Ingreso mensual", "G√©nero"], answer: "G√©nero" },
            { question: "¬øCu√°l de las siguientes variables es de nivel ordinal?", options: ["Nivel educativo (primaria, secundaria, universidad)", "Color favorito", "N√∫mero de tel√©fono", "Tipo de discapacidad"], answer: "Nivel educativo (primaria, secundaria, universidad)" },
            { question: "¬øQu√© representa la probabilidad en el contexto de pruebas estad√≠sticas?", options: ["La frecuencia con la que se repite un dato", "El n√∫mero total de participantes", "La certeza de que un evento ocurrir√°", "La posibilidad de que un resultado ocurra por azar"], answer: "La posibilidad de que un resultado ocurra por azar" },
            { question: "¬øCu√°l es una ventaja de usar pruebas no param√©tricas en estudios sociales?", options: ["Son m√°s precisas con datos ordinales o nominales", "No necesitan hip√≥tesis", "Evitan el uso de computadoras", "Requieren menos participantes"], answer: "Son m√°s precisas con datos ordinales o nominales" },
            { question: "¬øQu√© prueba se usar√≠a para comparar la satisfacci√≥n de usuarios entre dos centros comunitarios?", options: ["Prueba de correlaci√≥n", "Prueba de regresi√≥n lineal", "Prueba de varianza", "Prueba de Chi-cuadrado"], answer: "Prueba de Chi-cuadrado" },
            { question: "¬øQu√© indica una diferencia significativa entre dos grupos en un estudio social?", options: ["Que los grupos son iguales", "Que se debe usar una prueba param√©trica", "Que los datos son inv√°lidos", "Que hay una relaci√≥n estad√≠stica entre las variables"], answer: "Que hay una relaci√≥n estad√≠stica entre las variables" },
            { question: "¬øCu√°l es el prop√≥sito principal de una prueba de significaci√≥n en investigaci√≥n social?", options: ["Confirmar que los datos son confiables", "Determinar si una diferencia observada es estad√≠sticamente relevante", "Calcular el promedio de respuestas", "Clasificar los tipos de encuestas"], answer: "Determinar si una diferencia observada es estad√≠sticamente relevante" },
            { question: "¬øQu√© elemento se necesita para realizar una prueba de significaci√≥n?", options: ["Una hip√≥tesis nula", "Un gr√°fico de barras", "Una entrevista", "Un mapa de calor"], answer: "Una hip√≥tesis nula" },
            { question: "¬øQu√© representa la hip√≥tesis alternativa en una prueba estad√≠stica?", options: ["Que no hay diferencia entre grupos", "Que los datos son inv√°lidos", "Que existe una diferencia significativa", "Que se debe repetir el estudio"], answer: "Que existe una diferencia significativa" },
            { question: "¬øCu√°l ser√≠a una hip√≥tesis nula en un estudio sobre violencia familiar?", options: ["La violencia familiar afecta el rendimiento escolar", "No hay relaci√≥n entre violencia familiar y rendimiento escolar", "La violencia familiar es com√∫n", "El rendimiento escolar depende del g√©nero"], answer: "No hay relaci√≥n entre violencia familiar y rendimiento escolar" },
            { question: "¬øQu√© se busca rechazar en una prueba de significaci√≥n?", options: ["La hip√≥tesis alternativa", "La hip√≥tesis nula", "Los datos recolectados", "El an√°lisis descriptivo"], answer: "La hip√≥tesis nula" },
            { question: "¬øQu√© representa un valor p en una prueba estad√≠stica?", options: ["El n√∫mero de participantes", "La probabilidad de que los resultados sean producto del azar", "El promedio de respuestas", "El tipo de variable"], answer: "La probabilidad de que los resultados sean producto del azar" },
            { question: "¬øQu√© significa un valor p mayor a $0.05$?", options: ["Que hay una diferencia significativa", "Que se rechaza la hip√≥tesis nula", "Que no se puede afirmar una diferencia estad√≠stica", "Que los datos son inv√°lidos"], answer: "Que no se puede afirmar una diferencia estad√≠stica" },
            { question: "¬øEn qu√© contexto se usa la probabilidad en trabajo social?", options: ["Para calcular el n√∫mero de encuestas", "Para estimar la posibilidad de que un fen√≥meno ocurra", "Para clasificar tipos de violencia", "Para medir la edad promedio"], answer: "Para estimar la posibilidad de que un fen√≥meno ocurra" },
            { question: "¬øQu√© implica una probabilidad del $90\\%$ en un estudio de intervenci√≥n social?", options: ["Que los resultados son poco confiables", "Que hay alta certeza de que el efecto observado es real", "Que se debe repetir el estudio", "Que los datos son nominales"], answer: "Que hay alta certeza de que el efecto observado es real" },
            { question: "¬øCu√°l es el nivel de significaci√≥n m√°s com√∫n en estudios sociales?", options: ["$0.10$", "$0.05$", "$0.50$", "$0.01$"], answer: "$0.05$" },
            { question: "¬øQu√© caracteriza a las pruebas no param√©tricas?", options: ["Requieren datos con distribuci√≥n normal", "Se aplican a datos categ√≥ricos u ordinales", "Solo se usan en f√≠sica", "No permiten comparar grupos"], answer: "Se aplican a datos categ√≥ricos u ordinales" },
            { question: "¬øCu√°l es una prueba no param√©trica com√∫n en trabajo social?", options: ["ANOVA", "Regresi√≥n lineal", "Chi-cuadrado", "T de Student"], answer: "Chi-cuadrado" },
            { question: "¬øCu√°ndo se recomienda usar una prueba no param√©trica?", options: ["Cuando los datos son num√©ricos y normales", "Cuando los datos son ordinales o nominales", "Cuando hay m√°s de 100 participantes", "Cuando se usa Excel"], answer: "Cuando los datos son ordinales o nominales" },
            { question: "¬øQu√© tipo de datos se analizan con la prueba de Chi-cuadrado?", options: ["Datos continuos", "Datos categ√≥ricos", "Datos con decimales", "Datos de tiempo"], answer: "Datos categ√≥ricos" },
            { question: "¬øQu√© permite identificar una prueba de Mann-Whitney en trabajo social?", options: ["Diferencias entre dos grupos ordinales", "Correlaciones entre variables", "Promedios de ingresos", "Tipos de violencia"], answer: "Diferencias entre dos grupos ordinales" },
            { question: "¬øCu√°l es una variable nominal en estudios sociales?", options: ["Edad", "G√©nero", "Nivel educativo", "Puntaje en test"], answer: "G√©nero" },
            { question: "¬øQu√© tipo de variable es 'nivel de satisfacci√≥n' (bajo, medio, alto)?", options: ["Nominal", "Ordinal", "Continua", "Binaria"], answer: "Ordinal" },
            { question: "¬øQu√© prueba se usa para comparar respuestas de tipo 's√≠' o 'no'?", options: ["Prueba t", "Prueba de Chi-cuadrado", "Regresi√≥n", "ANOVA"], answer: "Prueba de Chi-cuadrado" },
            { question: "¬øQu√© tipo de an√°lisis se aplica a variables ordinales en encuestas sociales?", options: ["Media aritm√©tica", "Prueba de rangos", "Desviaci√≥n est√°ndar", "Histograma"], answer: "Prueba de rangos" },
            { question: "¬øQu√© representa una escala de Likert en trabajo social?", options: ["Una forma de medir ingresos", "Una escala ordinal para medir actitudes", "Un tipo de entrevista", "Un gr√°fico de barras"], answer: "Una escala ordinal para medir actitudes" },
            { question: "¬øQu√© tipo de prueba usar√≠as para analizar si el tipo de vivienda est√° relacionado con el acceso a servicios sociales?", options: ["Prueba t", "Prueba de Chi-cuadrado", "Regresi√≥n lineal", "Prueba de rangos"], answer: "Prueba de Chi-cuadrado" },
            { question: "¬øQu√© representa una diferencia significativa en el acceso a salud entre comunidades rurales y urbanas?", options: ["Que los datos son iguales", "Que hay una relaci√≥n estad√≠stica entre el tipo de comunidad y el acceso", "Que se debe usar una escala de Likert", "Que no se puede analizar"], answer: "Que hay una relaci√≥n estad√≠stica entre el tipo de comunidad y el acceso" },
            { question: "¬øQu√© variable ser√≠a nominal en un estudio sobre discriminaci√≥n laboral?", options: ["Edad", "G√©nero", "A√±os de experiencia", "Nivel de ingresos"], answer: "G√©nero" },
            { question: "¬øQu√© tipo de variable es 'frecuencia de participaci√≥n en actividades comunitarias' (nunca, a veces, siempre)?", options: ["Nominal", "Ordinal", "Continua", "Binaria"], answer: "Ordinal" },
            { question: "¬øQu√© prueba usar√≠as para comparar niveles de satisfacci√≥n entre tres programas sociales?", options: ["Prueba de rangos de Kruskal-Wallis", "Prueba t", "Regresi√≥n", "Prueba de correlaci√≥n"], answer: "Prueba de rangos de Kruskal-Wallis" },
            { question: "¬øQu√© representa un valor p de $0.01$ en un estudio sobre violencia de g√©nero?", options: ["Alta probabilidad de que los resultados sean producto del azar", "Alta significaci√≥n estad√≠stica", "Datos inv√°lidos", "Falta de correlaci√≥n"], answer: "Alta significaci√≥n estad√≠stica" },
            { question: "¬øQu√© tipo de prueba usar√≠as para analizar si el nivel educativo influye en la percepci√≥n de justicia social?", options: ["Prueba de Chi-cuadrado", "Prueba t", "Regresi√≥n log√≠stica", "Prueba de correlaci√≥n"], answer: "Prueba de Chi-cuadrado" },
            { question: "¬øQu√© representa una prueba de Wilcoxon en trabajo social?", options: ["Comparaci√≥n de promedios", "Comparaci√≥n de rangos entre dos grupos relacionados", "An√°lisis de varianza", "C√°lculo de frecuencias"], answer: "Comparaci√≥n de rangos entre dos grupos relacionados" },
            { question: "¬øQu√© tipo de variable es 'tipo de discapacidad' en un estudio de inclusi√≥n educativa?", options: ["Nominal", "Ordinal", "Continua", "Binaria"], answer: "Nominal" },
            { question: "¬øQu√© representa una correlaci√≥n positiva entre autoestima y participaci√≥n comunitaria?", options: ["Que ambas variables disminuyen", "Que no hay relaci√≥n", "Que al aumentar una, tambi√©n aumenta la otra", "Que se deben usar pruebas nominales"], answer: "Que al aumentar una, tambi√©n aumenta la otra" },
            { question: "¬øQu√© implica no rechazar la hip√≥tesis nula en un estudio social?", options: ["Que hay una diferencia significativa", "Que no se encontr√≥ evidencia estad√≠stica suficiente", "Que los datos son inv√°lidos", "Que se debe repetir el estudio"], answer: "Que no se encontr√≥ evidencia estad√≠stica suficiente" },
            { question: "¬øQu√© tipo de prueba usar√≠as para comparar la percepci√≥n de seguridad entre hombres y mujeres?", options: ["Prueba de Chi-cuadrado", "Prueba t", "Regresi√≥n", "Prueba de Wilcoxon"], answer: "Prueba de Chi-cuadrado" },
            { question: "¬øQu√© representa una prueba de Spearman en trabajo social?", options: ["Correlaci√≥n entre variables ordinales", "Comparaci√≥n de medias", "An√°lisis de frecuencias", "C√°lculo de probabilidades"], answer: "Correlaci√≥n entre variables ordinales" },
            { question: "¬øQu√© tipo de variable es 'estado civil' en un estudio sobre acceso a vivienda?", options: ["Nominal", "Ordinal", "Continua", "Binaria"], answer: "Nominal" },
            { question: "¬øQu√© representa una diferencia no significativa en un estudio sobre abandono escolar?", options: ["Que los datos son err√≥neos", "Que no hay evidencia estad√≠stica de diferencia", "Que se debe usar otra prueba", "Que el fen√≥meno no existe"], answer: "Que no hay evidencia estad√≠stica de diferencia" },
            { question: "¬øQu√© prueba usar√≠as para analizar si el tipo de empleo est√° relacionado con el estr√©s laboral?", options: ["Prueba de Chi-cuadrado", "Prueba t", "Regresi√≥n lineal", "Prueba de rangos"], answer: "Prueba de Chi-cuadrado" },
            { question: "¬øQu√© representa una escala ordinal en encuestas de bienestar emocional?", options: ["Clasificaci√≥n sin orden", "Medici√≥n con orden l√≥gico", "Datos num√©ricos", "Datos binarios"], answer: "Medici√≥n con orden l√≥gico" },
            { question: "¬øQu√© tipo de prueba usar√≠as para comparar el nivel de satisfacci√≥n antes y despu√©s de una intervenci√≥n social?", options: ["Prueba de Wilcoxon", "Prueba de Chi-cuadrado", "Prueba t", "Prueba de correlaci√≥n"], answer: "Prueba de Wilcoxon" },
            { question: "¬øQu√© representa un valor p de $0.20$ en un estudio sobre percepci√≥n de equidad?", options: ["Alta significaci√≥n", "Baja probabilidad de error", "No hay evidencia estad√≠stica suficiente", "Datos inv√°lidos"], answer: "No hay evidencia estad√≠stica suficiente" },
            { question: "¬øQu√© tipo de variable es 'preferencia por tipo de ayuda' (econ√≥mica, psicol√≥gica, educativa)?", options: ["Nominal", "Ordinal", "Continua", "Binaria"], answer: "Nominal" }
        ];

        // Acceso global a jsPDF.jsPDF
        const { jsPDF } = window.jspdf;


        /**
         * Inicializa Firebase y la autenticaci√≥n
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                showMessage("Firebase y Autenticaci√≥n listos. Ingrese sus datos para comenzar.", 'info');
            } catch (error) {
                showMessage("Error al inicializar Firebase: " + error.message, 'error');
            }
        }

        /**
         * Maneja el formulario de inicio de sesi√≥n y verifica el correo en Firestore
         */
        async function handleLogin(event) {
            event.preventDefault();
            const nameInput = document.getElementById('student-name');
            const emailInput = document.getElementById('student-email');
            const loginFormSubmit = document.getElementById('login-form-submit');
            
            loginFormSubmit.disabled = true;
            loginFormSubmit.textContent = "Verificando...";

            const name = nameInput.value.trim();
            const email = emailInput.value.trim().toLowerCase();

            if (!name || !email) {
                showMessage("Por favor, ingrese su nombre y correo electr√≥nico.", 'error');
                loginFormSubmit.disabled = false;
                loginFormSubmit.textContent = "Verificar y Continuar";
                return;
            }

            userData.name = name;
            userData.email = email;

            const attemptsCollectionPath = `artifacts/${appId}/public/data/exam_attempts`;
            // Usamos el email como ID del documento
            const attemptDocRef = doc(db, attemptsCollectionPath, email);

            try {
                showMessage("Verificando si ya realiz√≥ el examen...", 'info');
                const docSnap = await getDoc(attemptDocRef);

                if (docSnap.exists()) {
                    // El correo ya existe, bloquear intento.
                    showMessage(`El correo electr√≥nico **${email}** ya ha sido utilizado para realizar este examen. No puede volver a intentarlo.`, 'error');
                    document.getElementById('start-exam-button').disabled = true;
                } else {
                    // Correo no encontrado, puede tomar el examen.
                    showMessage(`Verificaci√≥n exitosa. ¬°Mucha suerte, **${name}**! Tiene ${TIME_PER_QUESTION} segundos por pregunta.`, 'success');
                    document.getElementById('start-exam-button').disabled = false;
                    nameInput.disabled = true;
                    emailInput.disabled = true;
                    loginFormSubmit.classList.add('hidden');
                    document.getElementById('start-exam-button').classList.remove('hidden');
                }
            } catch (error) {
                showMessage(`Error al verificar el examen. Por favor, intente de nuevo.`, 'error');
                console.error("Error checking exam attempt:", error);
            } finally {
                loginFormSubmit.disabled = false;
                loginFormSubmit.textContent = "Verificar y Continuar";
            }
        }

        /**
         * Selecciona 'count' preguntas aleatorias de 'bank'
         */
        function selectRandomQuestions(bank, count) {
            const shuffled = [...bank].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        /**
         * Inicia el examen
         */
        function startExam() {
            // 1. Seleccionar 10 preguntas al azar
            selectedQuestions = selectRandomQuestions(questionBank, 10);
            
            // 2. Ocultar login y mostrar examen
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('exam-screen').classList.remove('hidden');

            // 3. Iniciar la primera pregunta
            currentQuestionIndex = 0;
            renderSingleQuestion();
        }

        /**
         * Renderiza la pregunta actual y comienza el temporizador
         */
        function renderSingleQuestion() {
            // Detener y limpiar cualquier temporizador previo
            clearTimeout(timerTimeout);
            clearInterval(countdownInterval);
            
            if (currentQuestionIndex >= selectedQuestions.length) {
                submitExam();
                return;
            }

            const q = selectedQuestions[currentQuestionIndex];
            const container = document.getElementById('questions-container');
            
            // 1. Renderizar la pregunta
            container.innerHTML = `
                <div class="question-card bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                        <p class="font-bold text-xl text-indigo-700">Pregunta ${currentQuestionIndex + 1} de ${selectedQuestions.length}</p>
                        <div id="timer-display" class="text-xl font-extrabold text-red-600 bg-red-100 px-3 py-1 rounded-full">
                            ${TIME_PER_QUESTION}s
                        </div>
                    </div>
                    
                    <p class="text-gray-800 text-lg mb-6">${q.question}</p>
                    
                    <div id="options-q${currentQuestionIndex}">
                        ${q.options.map(option => `
                            <label class="block mb-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-indigo-50 transition duration-150">
                                <input type="radio" name="current-question" value="${option}" 
                                    ${userSelections[currentQuestionIndex] === option ? 'checked' : ''}
                                    class="mr-3 text-indigo-600 focus:ring-indigo-500"
                                    onchange="window.recordSelection(this.value, ${currentQuestionIndex})">
                                ${option}
                            </label>
                        `).join('')}
                    </div>
                </div>
                <button onclick="window.nextQuestion()" id="next-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                    Siguiente Pregunta
                </button>
            `;

            // 2. Iniciar el temporizador
            startTimer();
        }

        /**
         * Inicia el temporizador de 45 segundos
         */
        function startTimer() {
            let timeLeft = TIME_PER_QUESTION;
            const timerDisplay = document.getElementById('timer-display');

            // Intervalo para actualizar el contador
            countdownInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `${timeLeft}s`;
                if (timeLeft <= 10) {
                    timerDisplay.classList.remove('text-red-600', 'bg-red-100');
                    timerDisplay.classList.add('text-yellow-700', 'bg-yellow-100');
                }
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);

            // Timeout para pasar autom√°ticamente a la siguiente pregunta
            timerTimeout = setTimeout(() => {
                showMessage(`Tiempo agotado para la pregunta ${currentQuestionIndex + 1}.`, 'error');
                nextQuestion();
            }, TIME_PER_QUESTION * 1000);
        }

        /**
         * Registra la selecci√≥n del usuario
         */
        function recordSelection(value, index) {
            userSelections[index] = value;
        }

        /**
         * Pasa a la siguiente pregunta o finaliza el examen
         */
        function nextQuestion() {
            // Detener el temporizador inmediatamente
            clearTimeout(timerTimeout);
            clearInterval(countdownInterval);

            currentQuestionIndex++;
            renderSingleQuestion();
        }

        /**
         * Maneja la sumisi√≥n del examen: calcula puntaje, guarda y muestra resultados
         */
        async function submitExam() {
            const submitButton = document.getElementById('next-button');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = "Calculando...";
            }
            showMessage("Calculando resultados y guardando intento...", 'info');

            // 1. Calcular el puntaje
            let score = 0;
            const totalQuestions = selectedQuestions.length;
            
            selectedQuestions.forEach((q, index) => {
                const selectedValue = userSelections[index];
                if (selectedValue && selectedValue === q.answer) {
                    score++;
                }
            });

            const percentage = ((score / totalQuestions) * 100).toFixed(0);

            // 2. Guardar el resultado en Firestore para evitar re-intentos
            try {
                const attemptsCollectionPath = `artifacts/${appId}/public/data/exam_attempts`;
                const attemptDocRef = doc(db, attemptsCollectionPath, userData.email);

                const attemptData = {
                    name: userData.name,
                    email: userData.email,
                    score: score,
                    totalQuestions: totalQuestions,
                    percentage: percentage,
                    timestamp: new Date().toISOString(),
                    userId: auth.currentUser.uid
                };

                await setDoc(attemptDocRef, attemptData);
                console.log("Resultado del examen guardado en Firestore.");

                // 3. Mostrar resultados y PDF
                showResults(score, totalQuestions, percentage);

            } catch (error) {
                showMessage(`Error al guardar el resultado del examen: ${error.message}. Por favor, contacte al administrador.`, 'error');
                console.error("Error saving exam attempt:", error);
            }
        }

        /**
         * Muestra la pantalla de resultados y genera el PDF
         */
        function showResults(score, totalQuestions, percentage) {
            document.getElementById('exam-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            const scoreDisplay = document.getElementById('final-score');
            const gradeText = percentage >= 70 ? '¬°Aprobado! üéâ' : 'No Aprobado üòî';
            const gradeColor = percentage >= 70 ? 'text-green-600' : 'text-red-600';

            scoreDisplay.innerHTML = `
                <p class="text-3xl font-bold mb-4">¬°Examen Completado, ${userData.name}!</p>
                <p class="text-xl mb-2">Correo: <span class="font-medium text-gray-600">${userData.email}</span></p>
                <p class="text-xl mb-6">Puntuaci√≥n Final: <span class="font-extrabold text-indigo-700">${score}</span> de ${totalQuestions}</p>
                <p class="text-5xl font-extrabold ${gradeColor}">${percentage}%</p>
                <p class="text-2xl mt-4 font-semibold">${gradeText}</p>
            `;

            // FIX: Exportar la calificaci√≥n a variables globales para que el bot√≥n de descarga manual funcione.
            window.finalScore = score;
            window.finalPercentage = percentage;
            window.finalTotalQuestions = totalQuestions;

            showMessage("Su resultado ha sido guardado. Descargue su comprobante.", 'success');
            
            // Generar el PDF autom√°ticamente
            generatePDF(userData.name, userData.email, percentage, score, totalQuestions);
        }

        /**
         * Genera y descarga el PDF con los resultados
         * FIX: Se corrigi√≥ la inicializaci√≥n de jsPDF y se agreg√≥ el correo electr√≥nico.
         */
        function generatePDF(name, email, percentage, score, total) {
            // Inicializaci√≥n de jsPDF (importada globalmente)
            const doc = new jsPDF(); 

            const title = "Certificado de Calificaci√≥n del Examen";
            const date = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // T√≠tulo
            doc.setFontSize(24);
            doc.setTextColor(50, 60, 160);
            doc.text(title, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

            // L√≠nea separadora
            doc.setDrawColor(50, 60, 160);
            doc.line(20, 35, 190, 35);

            let currentY = 50;

            // Informaci√≥n del Alumno - Nombre
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text("Nombre del Estudiante:", 20, currentY);
            currentY += 10;
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text(name, 20, currentY);
            currentY += 15;

            // Informaci√≥n del Alumno - Correo
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text("Correo Electr√≥nico:", 20, currentY);
            currentY += 10;
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text(email, 20, currentY);
            currentY += 15;

            // Informaci√≥n del Alumno - Fecha
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text("Fecha de Realizaci√≥n:", 20, currentY);
            currentY += 10;
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text(date, 20, currentY);
            currentY += 20;

            // Calificaci√≥n (resaltada)
            doc.setDrawColor(50, 60, 160);
            doc.setFillColor(235, 240, 255);
            doc.rect(50, currentY, 110, 35, 'F'); // Recuadro para el puntaje

            doc.setFontSize(18);
            doc.setTextColor(50, 50, 50);
            doc.text("CALIFICACI√ìN FINAL", 105, currentY + 8, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text(`Puntaje: ${score}/${total}`, 105, currentY + 17, { align: 'center' });


            doc.setFontSize(36);
            const scoreColor = percentage >= 70 ? [0, 128, 0] : [200, 0, 0]; 
            doc.setTextColor(scoreColor[0], scoreColor[1], scoreColor[2]);
            doc.text(`${percentage}%`, 105, currentY + 30, { align: 'center' });
            
            // Pie de p√°gina
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text("Este documento certifica la finalizaci√≥n del examen y su resultado. Acceso √∫nico por correo electr√≥nico.", 105, 280, { align: 'center' });

            const filename = `Calificacion_${name.replace(/\s+/g, '_')}_${percentage}%.pdf`;
            doc.save(filename);
        }

        /**
         * Funci√≥n para mostrar mensajes de estado
         */
        function showMessage(text, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800', 'border-red-400', 'border-green-400', 'border-blue-400', 'bg-yellow-100', 'text-yellow-800', 'border-yellow-400');
            
            let classes = '';
            if (type === 'error') {
                classes = 'bg-red-100 text-red-800 border-red-400';
            } else if (type === 'success') {
                classes = 'bg-green-100 text-green-800 border-green-400';
            } else {
                classes = 'bg-blue-100 text-blue-800 border-blue-400';
            }

            messageBox.className = `p-4 mt-6 mb-6 rounded-lg border text-sm ${classes}`;
            messageBox.innerHTML = text;
        }

        // Inicializar Firebase al cargar la ventana
        window.onload = initializeFirebase;

        // Exportar funciones para que sean accesibles desde el HTML
        window.handleLogin = handleLogin;
        window.startExam = startExam;
        window.nextQuestion = nextQuestion;
        window.recordSelection = recordSelection;
        window.generatePDF = generatePDF; 
        window.userData = userData; 
        // Las variables finalScore, finalPercentage y finalTotalQuestions se crean en showResults
        
    </script>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">
    
    <div class="w-full max-w-2xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-800">Examen de Pruebas de Significancia y Variables</h1>
            <p class="text-gray-500 mt-2 font-semibold">Solo 10 preguntas al azar. Restricci√≥n de 45 segundos por pregunta. Acceso √∫nico por correo.</p>
        </header>

        <!-- Mensajes de Estado (Global) -->
        <div id="message-box" class="p-4 mt-6 mb-6 rounded-lg border text-sm bg-blue-100 text-blue-800 border-blue-400">
            Cargando...
        </div>

        <!-- 1. PANTALLA DE INICIO DE SESI√ìN / VERIFICACI√ìN -->
        <div id="login-screen" class="bg-white p-8 rounded-xl shadow-2xl transition-all duration-300 border border-gray-100">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Identificaci√≥n del Alumno</h2>
            
            <form id="login-form" onsubmit="window.handleLogin(event)">
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo:</label>
                    <input type="text" id="student-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Ej: Juan P√©rez">
                </div>
                <div class="mb-6">
                    <label for="student-email" class="block text-sm font-medium text-gray-700 mb-2">Correo Electr√≥nico (ser√° su ID √∫nico):</label>
                    <input type="email" id="student-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="ejemplo@dominio.com">
                </div>
                <button type="submit" id="login-form-submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md disabled:bg-indigo-400">
                    Verificar y Continuar
                </button>
            </form>

            <button onclick="window.startExam()" id="start-exam-button" disabled class="hidden w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 mt-4 shadow-md disabled:bg-gray-400">
                Iniciar Examen Ahora
            </button>
        </div>

        <!-- 2. PANTALLA DEL EXAMEN (pregunta por pregunta) -->
        <div id="exam-screen" class="hidden transition-all duration-300">
            <h2 class="text-3xl font-bold mb-8 text-indigo-700 text-center">Responda R√°pidamente</h2>
            
            <div id="questions-container" class="space-y-6">
                <!-- La pregunta actual se inyectar√° aqu√≠ por JavaScript -->
            </div>

        </div>

        <!-- 3. PANTALLA DE RESULTADOS -->
        <div id="results-screen" class="hidden bg-white p-8 rounded-xl shadow-2xl text-center transition-all duration-300 border border-gray-100">
            <div id="final-score" class="mb-8">
                <!-- El resultado se inyectar√° aqu√≠, incluyendo el correo -->
            </div>
            
            <p class="text-gray-600 mb-6">Su intento ha sido registrado. Haga clic para descargar su comprobante de calificaci√≥n.</p>
            
            <!-- FIX: El bot√≥n ahora usa las variables globales definidas en showResults (window.finalTotalQuestions) -->
            <button onclick="window.generatePDF(window.userData.name, window.userData.email, window.finalPercentage, window.finalScore, window.finalTotalQuestions)" class="bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                Descargar Comprobante PDF
            </button>
        </div>
    </div>
</body>
</html>
